{{define "content"}}
<div class="container map-container">
    <h1 class="page-title">Carte interactive</h1>
    <p class="map-intro">Carte des lieux de concerts. L‚ÄôAPI Spotify ne fournit pas de lieux ni dates de concerts ; la carte est affich√©e √† titre indicatif.</p>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <div class="map-wrapper">
        <div id="map" class="map-box"></div>
        {{if .Locations}}
        <div class="map-overlay-msg map-overlay-dismiss" id="map-overlay">
            <p><strong>{{len .Locations}} lieu(x)</strong> ‚Äî Cliquez sur un marqueur pour les d√©tails.</p>
        </div>
        {{else}}
        <div class="map-overlay-msg" id="map-overlay">
            <p><strong>Info</strong></p>
            <p>L‚ÄôAPI Spotify ne fournit pas de lieux ni dates de concerts. La carte reste interactive (zoom, d√©placement).</p>
        </div>
        {{end}}
    </div>

    {{if .Locations}}
    <div class="map-locations-list">
        <h2>Lieux de concerts</h2>
        <div class="location-cards">
            {{range .Locations}}
            <div class="location-card">
                <h3>üìç <a href="/location/{{urlpath .Location}}">{{.Location}}</a></h3>
                <p class="location-artists">{{range .Artists}}<span class="genre-tag">{{.}}</span>{{end}}</p>
                <p class="location-dates">{{range .Dates}}<span class="genre-tag">{{.}}</span>{{end}}</p>
                <a href="/location/{{urlpath .Location}}" class="btn-details">Voir les concerts</a>
            </div>
            {{end}}
        </div>
    </div>
    {{end}}

    <div class="map-actions">
        <a href="/artists" class="btn-back">‚Üê Retour aux artistes</a>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(function() {
    var mapEl = document.getElementById('map');
    if (!mapEl) return;
    var map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    var locations = {{.LocationsJSON}};

    for (var i = 0; i < locations.length; i++) {
        var loc = locations[i];
        var popupContent = '<strong>' + escapeHtml(loc.location) + '</strong><br/>';
        if (loc.artists) popupContent += 'Artistes: ' + loc.artists + '<br/>';
        if (loc.dates) popupContent += 'Dates: ' + loc.dates;
        L.marker([loc.lat, loc.lng]).addTo(map).bindPopup(popupContent);
    }

    var overlayEl = document.getElementById('map-overlay');
    if (overlayEl) overlayEl.addEventListener('click', function() {
        this.style.display = 'none';
    });

    function escapeHtml(s) {
        if (!s) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }
})();
</script>
{{end}}
